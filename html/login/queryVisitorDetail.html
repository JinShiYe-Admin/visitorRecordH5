<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/common.css" rel="stylesheet" />
		<link href="../../js/layui/css/layui.css" rel="stylesheet" />
		<style>
			[v-cloak] {
				visibility: hidden;
				display:none !important;
			}
			html,
			body {
				background-color: #FFFFFF;
			}
			
			.mui-bar~.mui-content {
				top: 44px;
				height: calc(100vh - 55px );
				background-color: #FFFFFF;
				padding:15px 0 0 15px;
			}
			
			/* 局部样式修改 */
			a:hover {
			    color: #FAFAFA;
			}
			.mui-h4, h4 {
			    font-size: 20px;
				color: #c3865c;
			}
			h1, h2, h3, h4, h5, h6 {
			    line-height: 1;
			    margin-top: 5px;
			    margin-bottom: 5px;
			}
			
			/* 自定义按钮样式 */
			.mui-btn-sys{
				border: 1px solid 3893D9;
				background-color: #3893D9;
				color: #FAFAFA;
			}
			.mui-btn, button, input[type=button], input[type=reset], input[type=submit]{
				padding: 6px 8px 4px;
			}
			.mui-btn-outlined-lg{
				width: 140px;
				margin: 0 10px;
				font-size: 18px;
				font-weight: 600;
				line-height: 2;
			}
			/* 分割线 */
			.line{
				background-color: #3893D9;
				margin-bottom: 0.3125rem;
				height: 0.125rem;
			}
			
			/* 身份证照片框样式 */
			.card-img{
				border: 1px solid rgba(210,207,200,.9);
				width:171px;
				height: 240px;
			}
			.card-text{
				display: block;
				margin: 63% 27% 0;
				width: 80px;
				font-size: 15px;
				color: grey;
			}
			
			/* 输入框样式和间距修改 */
			.mui-input-row label{
				font-size: 16px;
				width: 38%;
				font-weight: 600;
				text-align: left;
			}
			.mui-input-row label~input, .mui-input-row label~select, .mui-input-row label~textarea{
				border-bottom: 0px solid rgba(210,207,200,.8);
				width: 62%;
				float: left;
				
			}
			/* 输入框样式和间距修改 被访人/登记人 信息栏*/
			.mui-input-row-right label{
				width: 30%;
				font-weight: 600;
				text-align: left;
			}
			.mui-input-row-right label~input, .mui-input-row-right label~select, .mui-input-row-right label~textarea{
				border-bottom: 0px solid rgba(210,207,200,.8);
				width: 70%;
				float: left;
			}
			/* 输入框样式和间距修改 访客信息栏*/
			.mui-input-row-bottom-4 label{
				width: 45%;
				font-weight: 600;
				text-align: left;
			}
			.mui-input-row-bottom-4 label~input, .mui-input-row-bottom-4 label~select, .mui-input-row-bottom-4 label~textarea{
				border-bottom: 0px solid rgba(210,207,200,.8);
				width: 55%;
				float: left;
			}
			.mui-input-row-bottom-5 label{
				width: 30%;
				font-weight: 600;
				text-align: left;
			}
			.mui-input-row-bottom-5 label~input, .mui-input-row-bottom-5 label~select, .mui-input-row-bottom-5 label~textarea{
				border-bottom: 0px solid rgba(210,207,200,.8);
				width: 70%;
				float: left;
			}
			.mui-input-row-bottom-8 label{
				width: 23%;
				font-weight: 600;
				text-align: left;
			}
			.mui-input-row-bottom-8 label~input, .mui-input-row-bottom-8 label~select, .mui-input-row-bottom-8 label~textarea{
				border-bottom: 0px solid rgba(210,207,200,.8);
				width: 76%;
				float: left;
				margin-left: -2px;
			}
			.mui-input-row-bottom-12 label{
				width: 15%;
				font-weight: 600;
				text-align: left;
			}
			.mui-input-row-bottom-12 label~input, .mui-input-row-bottom-12 label~select, .mui-input-row-bottom-12 label~textarea{
				border-bottom: 0px solid rgba(210,207,200,.8);
				width: 85%;
				float: left;
			}
			
			/* 表单间距 */
			.mui-input-row{
				margin-top: 8px;
			}
			
			/* 弹出层 卡片样式修改 */
			.mui-card-header.mui-h4{
				border-top: 1px solid rgba(218,218,221,.9);
			}
			.mui-card-content-inner {
			    padding: 10px;
			}
			.layui-layer-btn.layui-layer-btn-c{
				background-color: #FFFFFF;
			}
			
			.mui-btn-outlined-print-lg{
				padding: 5px 10px;
				width: 100px;
				margin: 0 10px;
				font-size: 18px;
				font-weight: 600;
				line-height: 2;
			}
		</style>
	</head>
 
	<body>
		<header class="mui-bar mui-bar-nav" id="tempVue">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 v-cloak class="mui-title">{{titleName}}</h1>
		</header>
		<div id="datasource" class="mui-content mui-fullscreen">
			<div class="mui-row">
				<div class="mui-col-sm-8">
					<div class="mui-card">
						<div class="mui-card-header mui-h4">访客信息</div>
						<div class="mui-card-content" style="padding: 10px;">
							 <div class="mui-row">
							 	<div class="mui-col-sm-2">
							 		<img v-cloak v-if="IDCardImg" class="card-img" :src=IDCardImg>
							 		<div v-cloak v-else class="card-img" ><span class="card-text">身份证照片</span></div>
							 	</div>
							 	<div class="mui-col-sm-10">
							 		<div class="mui-row" style="margin-left:2rem;">
										<div class="mui-col-sm-6">
											<div class="mui-input-row">
												<label>姓名：</label>
												<input v-cloak :value="formData.visitor_name" type="text" placeholder=""  disabled="true">
											</div>
										</div>
										<div class="mui-col-sm-6">
											<div class="mui-input-row">
												<label>访客单号：</label>
												<input v-cloak :value="formData.record_code"  type="text" placeholder=""  disabled="true">
											</div>
										</div>
										<div class="mui-col-sm-6">
											<div class="mui-input-row">
												<label>性别：</label>
												<input v-cloak :value="formData.sex_name" type="text" placeholder=""  disabled="true">
											</div>
										</div>
										<div class="mui-col-sm-6">
											<div class="mui-input-row">
												<label>访问事由：</label>
												<input v-cloak :value="formData.visitor_for" type="text" placeholder=""  disabled="true">
											</div>
										</div>
										<div class="mui-col-sm-6">
											<div class="mui-input-row">
												<label>出生日期：</label>
												<input v-cloak :value="formData.visitor_birthday" type="text" placeholder=""  disabled="true">
											</div>
										</div>
										<div class="mui-col-sm-6">
											<div class="mui-input-row">
												<label>手机：</label>
												<input v-cloak :value="formData.visitor_phone" type="text" placeholder=""  disabled="true">
											</div>
										</div>
										<div class="mui-col-sm-6">
											<div class="mui-input-row">
												<label>证件类型：</label>
												<input v-cloak :value="formData.certificate_type" type="text" placeholder=""  disabled="true">
											</div>
										</div>
										<div class="mui-col-sm-6">
											<div class="mui-input-row">
												<label>随行人数：</label>
												<input v-cloak :value="formData.visitor_counter" type="text" placeholder=""  disabled="true">
											</div>
										</div>
										<div class="mui-col-sm-6">
											<div class="mui-input-row">
												<label>证件号码：</label>
												<input v-cloak :value="formData.certificate_number" type="text" placeholder=""  disabled="true">
											</div>
										</div>
										<div class="mui-col-sm-6">
											<div class="mui-input-row">
												<label>随身物品：</label>
												<input v-cloak :value="formData.visitor_goods" type="text" placeholder=""  disabled="true">
											</div>
										</div>
							 		</div>
							 	</div> 
							 </div>
							 <div class="mui-row">
								 <div class="mui-col-sm-8">
								 	<div class="mui-input-row mui-input-row-bottom-8">
								 		<label>来访单位：</label>
								 		<input v-cloak :value="formData.unit_name" type="text" placeholder=""  disabled="true">
								 	</div>
								 </div>
								 <div class="mui-col-sm-4">
								 	<div class="mui-input-row mui-input-row-bottom-4">
								 		<label>车牌号：</label>
								 		<input v-cloak :value="formData.plate_number" type="text" placeholder=""  disabled="true">
								 	</div>
								 </div>
							 	<div class="mui-col-sm-12">
							 		<div class="mui-input-row mui-input-row-bottom-12">
							 			<label>地址：</label>
							 			<input v-cloak :value="formData.address" type="text" placeholder=""  disabled="true">
							 		</div>
							 	</div>
							 	<div class="mui-col-sm-4">
							 		<div class="mui-input-row mui-input-row-bottom-4">
							 			<label>进入时间：</label>
							 			<input v-cloak :value="formData.in_time" type="text" placeholder=""  disabled="true">
							 		</div>
							 	</div>
							 	<div class="mui-col-sm-4">
							 		<div class="mui-input-row mui-input-row-bottom-4">
							 			<label>是否离开：</label>
							 			<input v-cloak :value="formData.leave_flag_name" type="text" placeholder=""  disabled="true">
							 		</div>
							 	</div>
							 	<div class="mui-col-sm-4">
							 		<div class="mui-input-row mui-input-row-bottom-4">
							 			<label>离开时间：</label>
							 			<input v-cloak :value="formData.leave_time" type="text" placeholder=""  disabled="true">
							 		</div>
							 	</div>
							 	<div class="mui-col-sm-12">
							 		<div class="mui-input-row mui-input-row-bottom-12">
							 			<label>备注：</label>
							 			<input v-cloak :value="formData.note" type="text" placeholder=""  disabled="true">
							 		</div>
							 	</div>
							 </div>
						</div>
					</div>
				</div>
				<div class="mui-col-sm-4">
					<div class="mui-card">
						<div class="mui-card-header mui-h4">被访人信息</div>
						<div class="mui-card-content" style="padding: 10px">
							<template v-if="formData.interviewee_type==0">
								<div class="mui-row">
									<div class="mui-col-sm-12">
										<div class="mui-input-row mui-input-row-right">
											<label>部门：</label>
											<input v-cloak :value="formData.dpt_name" type="text" placeholder="" disabled="true">
										</div>
									</div>
									<div class="mui-col-sm-12">
										<div class="mui-input-row mui-input-row-right">
											<label>姓名：</label>
											<input v-cloak :value="formData.teacher_name" type="text" placeholder="" disabled="true">
										</div>
									</div>
								</div>
							</template>
							<template v-else>
								<div class="mui-row">
									<div class="mui-col-sm-12">
										<div class="mui-input-row mui-input-row-right">
											<label>年级：</label>
											<input v-cloak :value="formData.grd_name" type="text" placeholder="" disabled="true">
										</div>
									</div>
									<div class="mui-col-sm-12">
										<div class="mui-input-row mui-input-row-right">
											<label>班级：</label>
											<input v-cloak :value="formData.cls_name" type="text" placeholder="" disabled="true">
										</div>
									</div>
									<div class="mui-col-sm-12">
										<div class="mui-input-row mui-input-row-right">
											<label>姓名：</label>
											<input v-cloak :value="formData.stu_name" type="text" placeholder="" disabled="true">
										</div>
									</div>
									<div class="mui-col-sm-12">
										<div class="mui-input-row mui-input-row-right">
											<label>班主任：</label>
											<input v-cloak :value="formData.head_teacher_name" type="text" placeholder="" disabled="true">
										</div>
									</div>
								</div>
							</template>
						</div>
					</div>
					<div style="margin-top: 1rem;"></div>
					<div class="mui-card">
						<div class="mui-card-header mui-h4">登记人信息</div>
						<div class="mui-card-content" style="padding: 10px ;">
							<div class="mui-row">
								<div class="mui-col-sm-12">
									<div class="mui-input-row mui-input-row-right">
										<label>姓名：</label>
										<input v-cloak :value="formData.create_user_name" type="text" placeholder=""  disabled="true">
									</div>
								</div>
								<div class="mui-col-sm-12">
									<div class="mui-input-row mui-input-row-right">
										<label>登记时间：</label>
										<input v-cloak :value="formData.create_time" type="text" placeholder=""  disabled="true">
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="mui-row" style="margin-top: 2rem;text-align: center;">
				<button type="button" @tap="printData()" class="mui-btn mui-btn-success mui-btn-outlined mui-btn-outlined-lg">打印</button>
				<button type="button" @tap="back()" class="mui-btn mui-btn-outlined mui-btn-outlined-lg">取消</button>
			</div>
			
			<!-- 该区域在页面上不显示，点击签离按钮后在弹出层内显示，但需要一起渲染 start-->
			<div id='layPrint' class="mui-row" style="display: none;">
				 <div class="mui-row" style="padding-top: 15px;">
					<div class="mui-col-sm-12" style="text-align: center;font-weight: 600;font-size: 22px;">访客单</div>
					<div class="mui-col-sm-12" style="text-align: left;padding-left: 50px;line-height: 2;">
						<p style="color: #000000;font-size: 16px;font-weight: 600;">姓名：{{formData.visitor_name}}</p>
						<p style="color: #000000;font-size: 16px;font-weight: 600;">性别：{{formData.visitor_sex==1?'男':'女'}}</p>
						<p style="color: #000000;font-size: 16px;font-weight: 600;">来访单位：{{formData.unit_name?formData.unit_name:'无'}}</p>
						<p style="color: #000000;font-size: 16px;font-weight: 600;">访问事由：{{formData.visitor_for}}</p>
						<template v-if="formData.interviewee_type==0">
							<p style="color: #000000;font-size: 16px;font-weight: 600;">被访人：{{formData.teacher_name}}</p>
							<p style="color: #000000;font-size: 16px;font-weight: 600;">部门：{{formData.dpt_name}}</p>
						</template>
						<template v-else>
							<p style="color: #000000;font-size: 16px;font-weight: 600;">被访人：{{formData.stu_name}}</p>
							<p style="color: #000000;font-size: 16px;font-weight: 600;">年级：{{formData.grd_name}}</p>
							<p style="color: #000000;font-size: 16px;font-weight: 600;">班级：{{formData.cls_name}}</p>
						</template> 
						<p style="color: #000000;font-size: 16px;font-weight: 600;">进入时间：{{formData.in_time}}</p>
					</div>
					<div class="mui-col-sm-12" style="text-align: center;">
						<img src="../../img/home/qrcode.png" >
						<p style="color: #000000;font-size: 15px;;">{{formData.record_code}}</p>
						<p style="color: #000000;font-size: 15px;">注：离开请交回值班室</p>
					</div>
					<div class="mui-col-sm-12" style="margin-top: 2rem;text-align: center;">
						<button type="button" @tap="printYes()" class="mui-btn mui-btn-outlined-print-lg">
							确认打印
						</button>
						<button type="button" @tap="printNo()" class="mui-btn mui-btn-outlined mui-btn-outlined-print-lg">
							取消
						</button>
					</div>
				 </div> 
			</div>
			<!-- 该区域在页面上不显示，点击签离按钮后在弹出层内显示，但需要一起渲染 end--> 
		</div>
		<script src="../../js/utils/mui.min.js"></script>
		<script src="../../js/utils/storageKeyName.js"></script>
		<!-- <script src="../../js/utils/vconsole.min.js"></script> -->
		<script src="../../js/utils/vue.js"></script>
		<script src="../../js/utils/publicProtocol.js"></script>
		<script src="../../js/utils/usbPrinter.js"></script>
		<script src="../../js/utils/store.js"></script>
		<script src="../../js/utils/utils.js"></script>
		<script src="../../js/utils/events.js"></script>
		<!--加密-->
		<script src="../../js/cloud/CloudFileUtil.js"></script>
		<script src="../../js/picVideoAudio/UploadHeadImage.js"></script>
		<script src="../../js/libs/RSA/Barrett.js"></script>
		<script src="../../js/libs/RSA/BigInt.js"></script>
		<script src="../../js/libs/RSA/RSA.js"></script>
		<script src="../../js/libs/encryption/RSAEncrypt.js"></script>
		<script src='../../js/libs/jquery.js'></script>
		<script src="../../js/qiniu/qiniu.js"></script>
		<script src="../../js/utils/cryption.js"></script>
		<script src="../../js/cloud/load.js"></script>
		<script src='../../js/libs/crypto-js/require.js'></script>
		<script src='../../js/libs/encryption/signHmacSHA1.js'></script>
		<script src='../../js/libs/encryption/sortSign.js'></script>
		<script src="../../js/layui/layui.js"></script>
		<script type="text/javascript">
			var $M = mui.init();
			//获取个人信息
			var personal = store.get(window.storageKeyName.PERSONALINFO);
			console.log('personal:' + JSON.stringify(personal));
			var curPage = {};
			var tempVue = new Vue({
				el: "#tempVue",
				data: {
					titleName: ''
				},
			});
			var datasource = new Vue({
				el: "#datasource",
				data: {
					formData:{},//
					IDCardImg:'',//身份证照片
					layer:'',//layer 弹出层对象
					pIndex:'',//layer 打印 弹出层id
				},
				methods:{
					back:function(){
						mui.back();
					},
					printData:function(){
						 layui.use(['jquery','layer'],function(){
							var $=layui.$
							datasource.pIndex=layer.open({
								type: 1
								,title: false //不显示标题栏
								,closeBtn: false
								,area: ['350px','580px']
								,shade: 0.7
								,id: 'LAY_layuipro' //设定一个id，防止重复弹出
								,btn: []
								,content: $('#layPrint')
								,yes: function(index,layero){}
							  });
						 });
					},
					printYes:function(){//确认打印
						mui.toast("正在打印凭条");
						plus.usbPrinter.printPage(function(args){
							console.log(args);
						},function(args){
							console.log(args);
						},this.formData)
						layer.close(this.pIndex);
					},
					printNo:function(){//取消打印
						layer.close(this.pIndex);
					},
				}
			});

			mui.plusReady(function() {
				curPage = utils.getDataFromUrl(window.location.href);
				console.log(JSON.stringify(curPage));
				tempVue.titleName = '访客信息详情';
				getVisitorDetail(curPage.id)
				if(curPage.img_url!='' && curPage.img_url!=null){
					getIDCardImg(curPage.img_url)
				}
			});
			
			//根据访客单号获取访客记录详情
			function getVisitorDetail(record_code){
				const params = {
					id:record_code, 
					index_code: curPage.access.split('#')[1],
				}
				postDataEncry(window.storageKeyName.INTERFACE_VISITOR + 'visitor/getById', {}, params, 2, function(da) {
					console.log("da: " + JSON.stringify(da));
					if (da.code == 0) {
							var datr=da.data
							datr.visitor_counter=datr.visitor_counter+' 人'
							datr.sex_name='女';
							if(datr.visitor_sex){
								datr.sex_name='男';
							}
							datr.leave_flag_name='未签离'
							if(datr.leave_flag){
								datr.leave_flag_name='已签离'
							}
						 datasource.formData=datr
					}else{
						mui.toast(da.msg);
					}
				});
			}
			
			//获取私有空间的身份证头像
			function getIDCardImg(domain){
				var wd =events.showWaiting();
				var getDownToken = {
					appId: window.storageKeyName.QN_APPID, //int 必填 项目id
					appKey: window.storageKeyName.QN_APPKEY,
					urls: [domain] //array 必填 需要获取下载token文件的路径
				}
				var getDownTokenUrl = window.storageKeyName.QNGETDOWNTOKENFILE;
				CloudFileUtil.getQNDownToken(getDownTokenUrl, getDownToken, function(data) {
					console.log("data: " + JSON.stringify(data));
					var urlStr = encodeURI(data.Data[0].Value)
					datasource.IDCardImg=urlStr;
					wd.close();
				}, function(xhr, type, errorThrown) {
					mui.toast('获取文件失败 ' + type); 
					wd.close();
				});
			}
		</script>
	</body>

</html>
