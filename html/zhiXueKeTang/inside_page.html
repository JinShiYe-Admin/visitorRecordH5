<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>资源包内页</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../css/mui.min.css">
		<style type="text/css">
			[v-cloak] {
				display: none;
			}

			.mui-table-view .mui-media-object {
				max-width: 100px;
			}

			.mui-table-view .mui-media-object.mui-pull-left {
				margin-right: 15px;
			}

			.mui-ellipsis-title {
				font-size: 18px;
				color: #000;
				overflow: hidden;
				word-break: break-all;
				display: -webkit-box;
				-webkit-line-clamp: 2;
				-webkit-box-orient: vertical;
				white-space: normal;
			}

			.mui-media-body {
				margin: 2px 0 0 0;
			}

			.mui-ellipsis {
				margin: 0px 0 0 0;
				height: 20px;
				overflow: hidden;
				word-break: break-all;
				display: -webkit-box;
				-webkit-line-clamp: 2;
				-webkit-box-orient: vertical;
				white-space: normal;
			}

			.ul-btn {
				display: inline;
				vertical-align: middle;
				float: right;
				height: 24px;
				padding: 2px 12px;
				background: #33CCFF;
				color: #fff;
				border: none;
			}

			.ul-p {
				width: 30%;
				display: inline;
				vertical-align: middle;
				font-size: 12px;
			}

			.page-img {
				width: 40px !important;
				height: 40px !important;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" style="background-color:#00CFBD;" id="packHead">
			<a id="returnBtn" class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"
				style="color:#ffffff"></a>
			<h1 class="mui-title" v-cloak style="color: white;font-size: 16px;">{{headTitle}}</h1>
		</header>
		<div id='scroll' class="mui-content">
			<div id='pages'>
				<!--<div v-if="orderList.length == 0" v-cloak style="text-align: center;margin:40% auto;">
					<img src="../../img/homeSchool/noData.png" style="width: 200px;" />
				</div>-->
				<div v-cloak class="mui-scroll">
					<ul class="mui-table-view">
						<li v-for="resourceModel in pageList" @click="toMealDetails(resourceModel)" class="mui-table-view-cell mui-media">
							<a href="javascript:;">
								<div v-if="resourceModel.is_pack">
									<img class="mui-media-object mui-pull-left"
										src="../../img/zhiXueKeTang/file-icons/ziyuanPack.png" />
								</div>
								<div v-else="">
									<img v-if="resourceModel.file_ext == 'mp4'" class="mui-media-object mui-pull-left"
										src="../../img/zhiXueKeTang/file-icons/mp4.png">
									<img v-else-if="resourceModel.file_ext == 'doc'"
										class="mui-media-object mui-pull-left"
										src="../../img/zhiXueKeTang/file-icons/doc.png" />
									<img v-else-if="resourceModel.file_ext == 'docx'"
										class="mui-media-object mui-pull-left"
										src="../../img/zhiXueKeTang/file-icons/docx.png" />
									<img v-else-if="resourceModel.file_ext == 'mp3'"
										class="mui-media-object mui-pull-left"
										src="../../img/zhiXueKeTang/file-icons/mp3.png">
									<img v-else-if="resourceModel.file_ext == 'asf'"
										class="mui-media-object mui-pull-left"
										src="../../img/zhiXueKeTang/file-icons/asf.png">
									<img v-else-if="resourceModel.file_ext == 'avi'"
										class="mui-media-object mui-pull-left"
										src="../../img/zhiXueKeTang/file-icons/avi.png">
									<img v-else-if="resourceModel.file_ext == 'flv'"
										class="mui-media-object mui-pull-left"
										src="../../img/zhiXueKeTang/file-icons/flv.png">
									<img v-else-if="resourceModel.file_ext == 'gif'"
										class="mui-media-object mui-pull-left"
										src="../../img/zhiXueKeTang/file-icons/gif.png">
									<img v-else-if="resourceModel.file_ext == 'ppt'"
										class="mui-media-object mui-pull-left"
										src="../../img/zhiXueKeTang/file-icons/ppt.png">
									<img v-else-if="resourceModel.file_ext == 'pptx'"
										class="mui-media-object mui-pull-left"
										src="../../img/zhiXueKeTang/file-icons/pptx.png">
									<img v-else-if="resourceModel.file_ext == 'xls'"
										class="mui-media-object mui-pull-left"
										src="../../img/zhiXueKeTang/file-icons/xls.png">
									<img v-else-if="resourceModel.file_ext == 'xlsx'"
										class="mui-media-object mui-pull-left"
										src="../../img/zhiXueKeTang/file-icons/xlsx.png">
									<img v-else-if="resourceModel.file_ext == 'mpg'"
										class="mui-media-object mui-pull-left"
										src="../../img/zhiXueKeTang/file-icons/mpg.png">
									<img v-else-if="resourceModel.file_ext == 'swf'"
										class="mui-media-object mui-pull-left"
										src="../../img/zhiXueKeTang/file-icons/swf.png">
									<img v-else-if="resourceModel.file_ext == 'ts'"
										class="mui-media-object mui-pull-left"
										src="../../img/zhiXueKeTang/file-icons/ts.png">
									<img v-else-if="resourceModel.file_ext == 'wav'"
										class="mui-media-object mui-pull-left"
										src="../../img/zhiXueKeTang/file-icons/wav.png">
									<img v-else-if="resourceModel.file_ext == 'wma'"
										class="mui-media-object mui-pull-left"
										src="../../img/zhiXueKeTang/file-icons/wma.png">
									<img v-else-if="resourceModel.file_ext == 'wmv'"
										class="mui-media-object mui-pull-left"
										src="../../img/zhiXueKeTang/file-icons/wmv.png">
									<img v-else-if="resourceModel.file_ext == 'pdf'"
										class="mui-media-object mui-pull-left"
										src="../../img/zhiXueKeTang/file-icons/pdf.png">
									<img v-else-if="resourceModel.file_ext == 'exe'"
										class="mui-media-object mui-pull-left"
										src="../../img/zhiXueKeTang/file-icons/exe.png">
									<img v-else-if="resourceModel.file_ext == 'jpg'"
										class="mui-media-object mui-pull-left"
										src="../../img/zhiXueKeTang/file-icons/jpg.png">
									<img v-else-if="resourceModel.file_ext == 'png'"
										class="mui-media-object mui-pull-left"
										src="../../img/zhiXueKeTang/file-icons/png.png">
									<img v-else-if="resourceModel.file_ext == 'rar'"
										class="mui-media-object mui-pull-left"
										src="../../img/zhiXueKeTang/file-icons/rar.png">
									<img v-else-if="resourceModel.file_ext == 'zip'"
										class="mui-media-object mui-pull-left"
										src="../../img/zhiXueKeTang/file-icons/zip.png">
									<img v-else-if="resourceModel.file_ext == 'txt'"
										class="mui-media-object mui-pull-left"
										src="../../img/zhiXueKeTang/file-icons/txt.png">
									<img v-else="" class="mui-media-object mui-pull-left"
										src="../../img/zhiXueKeTang/file-icons/other.png">
								</div>
								<div class="mui-media-body" style="font-size: 14px;color: #333;">
									{{resourceModel.name}}
									<p class="mui-ellipsis" style="font-size: 12px;color: #999;">
										{{resourceModel.create_time}} | {{resourceModel.owner_name}}
									</p>
								</div>
							</a>
						</li>
					</ul>
				</div>
			</div>
		</div>
		<script src="../../js/utils/storageKeyName.js"></script>
		<script src="../../js/utils/mui.min.js"></script>
		<script src="../../js/utils/vconsole.min.js"></script>
		<script src="../../js/utils/vue.js"></script>
		<script src="../../js/utils/utils.js"></script>
		<!--加密-->
		<script src="../../js/libs/RSA/Barrett.js"></script>
		<script src="../../js/libs/RSA/BigInt.js"></script>
		<script src="../../js/libs/RSA/RSA.js"></script>
		<script src="../../js/libs/encryption/RSAEncrypt.js"></script>
		<script src='../../js/libs/crypto-js/require.js'></script>
		<script src='../../js/libs/encryption/signHmacSHA1.js'></script>
		<script src='../../js/libs/jquery.js'></script>
		<script src='../../js/libs/encryption/sortSign.js'></script>
		<!---->
		<script src='../../js/libs/crypto-js/require.js'></script>
		<script src="../../js/utils/store.js"></script>
		<script src="../../js/utils/publicProtocol.js"></script>
		<script src="../../js/utils/events.js"></script>
		<script src="../../js/libs/jquery.js"></script>
		<script>
			mui.init();
			document.getElementById('returnBtn').addEventListener('tap', function() {
				mui.back();
			});
			var personal;
			var publicParameter;
			var curPage = {};
			mui.plusReady(function() {
				curPage = utils.getDataFromUrl(window.location.href);
				console.log('2222:' + JSON.stringify(curPage));
				getResPage();
				packHead.headTitle = curPage.name;
			});
			var packHead = new Vue({
				el: '#packHead',
				data: {
					headTitle: ''
				}
			});
			var pages = new Vue({
				el: '#pages',
				data: {
					pageList: [],
					personal: ""
				},
				methods: {
					toMealDetails: function(model) {
						console.log('toMealDetails:' + JSON.stringify(model));
						var deadline = getQueryString(model.openFileUrl).e; //得到当前文件过期时间 时间戳
						var timestamp = Math.round(new Date().getTime() / 1000).toString(); //得到当前时间戳
						if (timestamp - deadline > 0) { //过期
							mui.toast('当前文件已过期，请刷新列表重试！')
							return 0;
							//TODO 重新获取token
							//							DownloadUrl = 'https://developer.qiniu.com/kodo/manual/1202/download-token'
						}
						if (plus.networkinfo.getCurrentType() == plus.networkinfo.CONNECTION_NONE) {
							mui.toast('网络异常，请检查网络设置！');
							return;
						}
						if (model.is_pack) { //资源包
							utils.mOpenWithData("../../html/zhiXueKeTang/inside_page.html", model);
						} else if (model.file_ext == 'mp4' || model.file_ext == 'mp3' || model.file_ext == 'wmv' ||
							model.file_ext == 'wma' || model.file_ext == 'mpg' || model.file_ext == 'avi' || model
							.file_ext == 'flv' || model.file_ext == 'mkv' || model.file_ext == 'asf') { //视频、音频
							if (model.file_ext == 'mp4' || model.file_ext == 'mp3') {
								utils.mOpenWithData("../../html/zhiXueKeTang/playVideo.html", model);
							} else {
								if (plus.os.name == 'Android') {
									plus.runtime.openURL(model.openFileUrl);
								} else {
									plus.runtime.openWeb(model.openFileUrl);
								}
							}
						} else if (model.file_ext == 'jpg' || model.file_ext == 'png' || model.file_ext ==
							'gif') { //照片
							if (plus.os.name == 'Android') {
								plus.nativeUI.previewImage([model.openFileUrl]);
							} else {
								plus.nativeUI.previewImage(model.openFileUrl, {
									current: 0,
									loop: false,
									indicator: 'number'
								});
							}
						} else if (model.file_ext == 'ppt' || model.file_ext == 'pptx' || model.file_ext == 'doc' ||
							model.file_ext == 'docx' || model.file_ext == 'pdf' || model.file_ext == 'xlsx' || model
							.file_ext == 'xls') { //文档
							if (plus.os.name == 'Android') {
								plus.runtime.openURL(model.openFileUrl);
							} else {
								plus.runtime.openWeb(model.openFileUrl);
							}
						} else {
							mui.toast('不支持查看此类型文件');
						}
					}
				}
			});

			// 查询资源包子列表
			function getResPage() {
				var tempData = {
					pid: curPage.id, //资源包id
					index_code: curPage.access
				}
				postDataEncry(window.storageKeyName.INTERFACE_ZXKT + '/resource/packageList', {}, tempData, 2, function(
					data) {
					events.closeWaiting();
					if (data.code == 0) {
						for (var i = 0; i < data.data.list.length; i++) {
							var tempM = data.data.list[i];
							if (tempM.convert_file_url == null || tempM.convert_file_url.length == 0) {
								tempM.openFileUrl = tempM.original_file_url;
							} else {
								tempM.openFileUrl = tempM.convert_file_url;
							}
						}
						pages.pageList = [].concat(data.data.list);
					} else {
						mui.toast(data.msg);
					}
				});
			}

			function getQueryString(url) {
				try {
					var theRequest = new Object();
					if (url.indexOf("?") != -1) {
						var str = url.split('?')[1];
						strs = str.split("&");
						for (var i = 0; i < strs.length; i++) {
							theRequest[strs[i].split("=")[0]] = (strs[i].split("=")[1]);
						}
					}
					return theRequest;
				} catch (e) {
					console.error('对userbus字段进行学段去重时发生异常,' + e);
					console.error('====================')
					console.error(e.stack);
					console.error('====================')
					return {};
				}
			}
		</script>
	</body>

</html>
