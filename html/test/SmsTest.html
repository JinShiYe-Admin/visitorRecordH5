<!doctype html>
<html>
	<!-- 考务模块  列表页

 -->
	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<!-- <link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/common.css" rel="stylesheet" />
		<link href="../../css/mui.poppicker.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../fonts/iconfont1.css" />
		<link rel="stylesheet" href="../../css/utils/MultiMedia.css" />
		<link rel="stylesheet" href="../../css/utils/preview.css" />
		<link rel="stylesheet" href="../../css/utils/audiopopover.css" /> -->
		<link rel="stylesheet" href="../../css/mui.picker.min.css" />
		<link rel="stylesheet" type="text/css" href="../../css/icons-extra.css" />
		<style>
			 
			.mui-bar .mui-title{
				left: 70px; 
				right:70px;
			}
			 
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" id="tempVue">
			<!-- <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 v-cloak class="mui-title">{{titleName}}</h1>
			<a @click="submit()" class="mui-pull-right" style="font-size: 0.875rem">确定</a> -->
			
			
			<a v-show="SMS" @click="clickTime()" class="mui-pull-right" style="font-size: 0.875rem;margin-right: 10px;margin-top: 3px;width: 43px;height: 43px;"><span class="mui-icon-extra mui-icon-extra-outline"></span></a>
		
		
		</header>
		<div v-cloak id="datasource" class="mui-content mui-fullscreen" style="z-index:0">
			
			
			<div v-show="SHOWTIME" style="position: fixed;z-index: 5;background: rgba(0,0,0,0.3);width: 100%;height: 100%;">
			   <div style="width: 100%;background: #FFFFFF;">
				  <ul class="mui-table-view mui-table-view-radio">
				  	<li class="mui-table-view-cell mui-selected"  @click="JS()"><a class="mui-navigate-right">即时发送</a></li>
				  	<li class="mui-table-view-cell" @click="YS()"><a class="mui-navigate-right" ><span>延时发送</span><span style="position: absolute;right: 80px;border: 1px solid #00CFBD;color: #FFFFFF;background-color: #00CFBD;border-radius: 5px;padding: 0 3px;" @click="shouTime()">{{delay_time}}<span class="mui-icon mui-icon-compose"></span></span></a></li>
				  </ul>
			   </div>
			</div>
			
			
			<div v-cloak class="mui-scroll-wrapper" style="margin-top: 44px;">
				<div v-cloak class="mui-scroll">
					<div class="" v-cloak style="margin-top: 0.625rem;">
						<!-- <div v-cloak class="mui-input-row">
							<textarea style="border: 0px solid rgba(0,0,0,.2);"  maxlength="300" v-model="formData.comment" rows="5" placeholder="请输入通知内容,最多300字"></textarea>
						</div> -->
						
						
						<div v-show="SHOW" >
							<span style="margin-left: 15px;font-size: 14px;">同步发送短信</span>
							<div class="mui-switch mui-switch-mini mui-active" @click="addSms" style="position: absolute;right: 15px;margin-top: -22px;">
								<div class="mui-switch-handle"></div>
							</div>
						</div> 
						<div v-show="SMS" style="margin: 15px 0">
							<span style="margin-left: 15px;font-size: 14px;">添加签名</span>
							<div class="mui-switch mui-switch-mini" @click="addSign" style="position: absolute;right: 15px;margin-top: -22px;">
								<div class="mui-switch-handle"></div>
							</div>
						</div>
						<p style="margin:0 15px;text-align: right;" v-if="SMS && is_delay==='0'">立即发送</p>
						<p style="margin:0 15px;text-align: right;" v-else-if="SMS && is_delay==='1'">{{delay_time}}后发送</p>
						
						
						<!-- <div v-cloak class="mui-input-row">
							<label class="aCss">接收人</label>
						</div>
						<div class="line"></div>
						<div v-cloak class="mui-input-row">
							<p style="margin:10px 0 0 15px;">全体学生</p>
						</div> -->
					</div>
				</div>
			</div>
		</div>
		<!-- <script src="../../js/utils/mui.min.js"></script>
		<script src="../../js/utils/vue.js"></script>
		<script src="../../js/utils/storageKeyName.js"></script>
		<script src="../../js/utils/publicProtocol.js"></script>
		<script src="../../js/utils/events.js"></script>
		
		 
		<script src="../../js/utils/store.js"></script>
		<script src="../../js/utils/utils.js"></script>
		<script src="../../js/utils/vconsole.min.js"></script>
		<script src="../../js/qiniu/cloudutil.js"></script>
		<script src="../../js/utils/mui.picker.min.js"></script>
		<script src="../../js/utils/mui.poppicker.js"></script>
		-->
		<script src="../../js/utils/mui.picker.min.js"></script> 
		<script src="../../js/utils/moment.min.js"></script>
		<script src="../../js/utils/SMS-Utils.js"></script>
		<!-- <script src="../../js/libs/RSA/Barrett.js"></script>
		<script src="../../js/libs/RSA/BigInt.js"></script>
		<script src="../../js/libs/RSA/RSA.js"></script>
		<script src="../../js/libs/encryption/RSAEncrypt.js"></script>
		<script src='../../js/libs/crypto-js/require.js'></script>
		<script src='../../js/libs/encryption/signHmacSHA1.js'></script>
		<script src='../../js/libs/jquery.js'></script>
		<script src='../../js/libs/encryption/sortSign.js'></script> -->
		<script type="text/javascript">
			var $M = mui.init();
			//获取个人信息
			var personal = store.get(window.storageKeyName.PERSONALINFO);
			console.log('personal:' + JSON.stringify(personal));
			var curPage = {};
			
			var tempVue = new Vue({
				el: "#tempVue",
				data: {
					SMS:false,
					// titleName: '新建学校通知'
				},
				methods:{
					// submit:function(){//表单提交
					// 	if(datasource.formData.comment==''){
					// 		mui.toast('请输入通知内容...')
					// 	}else{
					// 		events.showWaiting();
					// 		submitData(datasource.formData)
					// 	}
					// },
					clickTime:function(){
						datasource.SHOWTIME=!datasource.SHOWTIME
					},
				}
			});
			var datasource = new Vue({
				el: "#datasource",
				data: {
					SHOW:false,//是否显示发送短信
					SHOWTIME:false,//是否显示延迟发送选择
					SMS:false,//是否发送短信
					SIGN:false,//是否签名
					CONFIG:{},//短信配置 对象
					WORDS:[],//拒绝关键字 对象
					is_delay:'0',
					delay_time_data:'0-0-5',//延时多长时间,用于时间框赋值用
					delay_time:'0天0小时5分钟',//延时多长时间
					
					// formData: {
					// 	comment:'',//说明
					// }, 
				},
				methods:{
					addSign:function(){
						this.SIGN=!this.SIGN
					},
					addSms:function(){
						this.SMS=!this.SMS
						tempVue.SMS=!tempVue.SMS
					},
					shouTime:function(){
						let dLenth=31,hLength=23,mLength=59;
						let dStr='',hStr='',mStr='';
						for (var i = 0; i <= dLenth; i++) {
							if(i<dLenth){
								dStr+='{"text":"'+i+'天","value":"'+i+'"},'
							}else{
								dStr+='{"text":"'+i+'天","value":"'+i+'"}'
							}
						}
						
						for (var i = 0; i <= hLength; i++) {
							if(i<hLength){
								hStr+='{"text":"'+i+'小时","value":"'+i+'"},'
							}else{
								hStr+='{"text":"'+i+'小时","value":"'+i+'"}'
							}
						}
						
						for (var i = 1; i <= mLength; i++) {
							if(i<mLength){
								mStr+='{"text":"'+i+'分钟","value":"'+i+'"},'
							}else{
								mStr+='{"text":"'+i+'分钟","value":"'+i+'"}'
							}
						}
						
						var optionsJson = '{"value":"'+this.delay_time_data+'","type":"date","customData":{"y":['+dStr+'],"m":['+hStr+'],"d":['+mStr+']},"labels":["日", "时", "分"]}';
						var options = JSON.parse(optionsJson);
						let picker = new mui.DtPicker(options);
						picker.show(function(rs) {
							datasource.delay_time=rs.text.replace(/\-/g,'')
							datasource.delay_time_data=rs.value 
							datasource.SHOWTIME=false
							picker.dispose();
							picker = null;
						})
					},
					JS:function(){ 
						this.is_delay="0"
					},
					YS:function(){
						this.is_delay="1"
					},
				}
			});

			mui.plusReady(function() {
				// curPage = utils.getDataFromUrl(window.location.href);
				// tempVue.titleName = '添加'+curPage.title;
				
				//初始化参数  其中 MSG_TYPE,USER_TYPE,SMS_TYPE需要在storageKeyName中根据子系统短信定义自行配置
				SMSUtils.INDEX_CODE=curPage.index_code; //curPage.access.split('#')[1]
				SMSUtils.PERSONAL=store.get(window.storageKeyName.PERSONALINFO);
				SMSUtils.MSG_TYPE=window.storageKeyName.MSG_SMS.SCHOOL.MSG_TYPE;
				SMSUtils.USER_TYPE=window.storageKeyName.MSG_SMS.SCHOOL.USER_TYPE;
				SMSUtils.SMS_TYPE=window.storageKeyName.MSG_SMS.SCHOOL.SMS_TYPE;



				//阻尼系数、初始化刷新加载更多
				// var deceleration = mui.os.ios ? 0.003 : 0.0009;
				// mui('.mui-scroll-wrapper').scroll({
				// 	bounce: false,
				// 	indicators: true, //是否显示滚动条
				// 	deceleration: deceleration
				// });
				
				
				events.showWaiting();
				SMSUtils.getConfig((msg)=>{
					if(msg.SMS){
						datasource.CONFIG=msg.CONFIG
						SMSUtils.getSmsWords((msg2)=>{
							events.closeWaiting();
							datasource.WORDS=msg2.WORDS
						},2)
						//页面按钮控制，控制逻辑自己定义
						datasource.SMS=true
						datasource.SHOW=true
						tempVue.SMS=true
					}else{
						//页面按钮控制，控制逻辑自己定义
						datasource.SHOW=false
						datasource.SMS=false
						tempVue.SMS=false
						events.closeWaiting();
					}
				})
				
				
			});
		 
			
			// 提交表单数据
			function submitData(data) {
				// let comment=data.comment
				
				
				let showToast=false
				let words=[]
				for (var i = 0; i < datasource.WORDS.length; i++) {
					let word=datasource.WORDS[i].word
					if(comment.indexOf(word)!==-1){
						showToast=true
						words.push(word)
					}
				}
				if(showToast){
					mui.toast('含有禁止使用的关键词	‘'+words.join("/")+'’	请编辑后再尝试发送')
					events.closeWaiting();
					return 0
				}
				if(datasource.SIGN){
					comment+='[发送人：'+ personal.user_name+']'
				}
				let delayTime=moment().format('YYYY-MM-DD HH:mm:ss')
				if(datasource.is_delay==='1'){
					let delay_times=datasource.delay_time_data.split("-")
					delayTime=moment().add(delay_times[0], 'days').add(delay_times[1], 'hours').add(delay_times[2], 'minutes').format('YYYY-MM-DD HH:mm:ss');
				}
				
				// comData = {
				// 	unit_name:personal.unit_name,
				// 	send_unit_code:personal.unit_code,
				// 	send_user:personal.user_code,
				// 	send_user_tname:personal.user_name,
				// 	msg_content:comment,
				// 	msg_type:window.storageKeyName.MSG_SMS.SCHOOL.MSG_TYPE,
				// 	send_soure:"schapp#[APP]",
				// 	tousers:[],
				// 	hr_smsid:0,//固定值
				// 	sms_msgtype_code:window.storageKeyName.MSG_SMS.SCHOOL.SMS_TYPE,
				// 	is_delay:datasource.is_delay,
				// 	delay_time:delayTime,
				// 	servied:JSON.stringify(datasource.CONFIG)==='{}'?'100':datasource.CONFIG.serviced,
				// 	index_code:curPage.index_code
				// }
				// postDataEncry(window.storageKeyName.INTERFACE_SCHHOME + 'api/appsms/appsmsa', {}, comData, 2, function(datas) {
				// 	if (datas.code == 0) {
				// 		 if(datasource.SMS){
				// 			let id=datas.data
							let selectPeoples='具体业务中选择的接收人'
							let touser=[]
							for (var i = 0; i < selectPeoples.length; i++) {
								let obj={
									gen_type:SMSUtils.USER_TYPE,
									dpt_code:'',
									dpt_name:'',
									grd_code:selectData[i].grd_code,
									grd_name:selectData[i].grd_name,
									cls_code:selectData[i].cls_code,
									cls_name:selectData[i].cls_name,
									stu_code:selectData[i].stu_code,
									stu_name:selectData[i].stu_name,
									gen_code:'',
									gen_name:'',
								}
								touser.push(obj)
							}
							SMSUtils.sendSMS((msg)=>{
								events.closeWaiting();
								 mui.toast(datas.msg);
								setTimeout(function(){
									 mui.fire(plus.webview.currentWebview().opener(), 'refreshList', {});
									 mui.back()
								},1500)
							},message.is_delay,message.delay_time,message.msg_content,message.serviced,0,touser);
				// 		 }else{
				// 			 events.closeWaiting();
				// 			  mui.toast(datas.msg);
				// 			 setTimeout(function(){
				// 				 mui.fire(plus.webview.currentWebview().opener(), 'refreshList', {});
				// 				 mui.back()
				// 			 },1500)
				// 		 }
				// 	} else {
				// 		events.closeWaiting();
				// 		mui.toast(datas.msg);
				// 	}
				// });
			}
		</script>
	</body>

</html>