<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/common.css" rel="stylesheet" />
		<style>
			[v-cloak] {
				visibility: hidden;
				display:none !important;
			}
			html,
			body {
				background-color: #efeff4;
			}
			
			.mui-bar~.mui-content .mui-fullscreen {
				top: 44px;
				height: auto;
			}
			
			.mui-pull-top-tips {
				position: absolute;
				top: -20px;
				left: 50%;
				margin-left: -25px;
				width: 40px;
				height: 40px;
				border-radius: 100%;
				z-index: 1;
			}
			
			.mui-bar~.mui-pull-top-tips {
				top: 24px;
			}
			
			.mui-pull-top-wrapper {
				width: 42px;
				height: 42px;
				display: block;
				text-align: center;
				background-color: #efeff4;
				border: 1px solid #ddd;
				border-radius: 25px;
				background-clip: padding-box;
				box-shadow: 0 4px 10px #bbb;
				overflow: hidden;
			}
			
			.mui-pull-top-tips.mui-transitioning {
				-webkit-transition-duration: 200ms;
				transition-duration: 200ms;
			}
			
			.mui-pull-top-tips .mui-pull-loading {
				margin: 0;
			}
			
			.mui-pull-top-wrapper .mui-icon,
			.mui-pull-top-wrapper .mui-spinner {
				margin-top: 7px;
			}
			
			.mui-pull-top-wrapper .mui-icon.mui-reverse {
				/*-webkit-transform: rotate(180deg) translateZ(0);*/
			}
			
			.mui-pull-bottom-tips {
				text-align: center;
				background-color: #efeff4;
				font-size: 15px;
				line-height: 40px;
				color: #777;
			}
			
			.mui-pull-top-canvas {
				overflow: hidden;
				background-color: #fafafa;
				border-radius: 40px;
				box-shadow: 0 4px 10px #bbb;
				width: 40px;
				height: 40px;
				margin: 0 auto;
			}
			
			.mui-pull-top-canvas canvas {
				width: 40px;
			}
			
			.mui-slider-indicator.mui-segmented-control {
				background-color: #efeff4;
			}
			.peopleImg {
				width: 40px;
				height: 40px;
				border-radius: 50%;
			}
			.time {
				font-size: 14px;
				float: right;
				color: gray;
			}
			
			.biaoti {
				width: 80%;
				color: #000000;
				white-space: nowrap;
				text-overflow:ellipsis;
				overflow:hidden;
			}
			
			.tempCss {
				font-size: 14px;
				color: gray;
			}
			.grdName{
				padding-top: 5px;
				margin-left: 20px;
				font-size: 17px;
				color: black;
				height: 30px;
			}
			.mui-table-view-cell.mui-collapse-3 .mui-table-view .mui-table-view-cell:last-child:after, .mui-table-view-cell.mui-collapse-3 .mui-table-view:after, .mui-table-view-cell.mui-collapse-3 .mui-table-view:before { height:0 }
			.mui-table-view-cell.mui-collapse-3>.mui-navigate-right:after, .mui-table-view-cell.mui-collapse-3>.mui-push-right:after { content:'\e581' }  
			.mui-table-view-cell.mui-collapse-3.mui-active { margin-top:-1px }  
			.mui-table-view-cell.mui-collapse-3.mui-active>.mui-navigate-right:after, .mui-table-view-cell.mui-collapse-3.mui-active>.mui-push-right:after { content:'\e580' }  
			.mui-table-view-cell.mui-collapse-3 .mui-collapse-content>.mui-input-group, .mui-table-view-cell.mui-collapse-3 .mui-collapse-content>.mui-slider { width:auto; height:auto; margin:-8px -15px }  
			.mui-table-view-cell.mui-collapse-3 .mui-collapse-content>.mui-slider { margin:-8px -16px }  
			.mui-table-view-cell.mui-collapse-3 .mui-table-view { display:none; margin-top:11px; margin-right:-15px; margin-bottom:-11px; margin-left:-15px; border:0 }  
			.mui-table-view-cell.mui-collapse-3 .mui-table-view.mui-table-view-chevron { margin-right:-65px }  
			.mui-table-view-cell.mui-collapse-3 .mui-table-view .mui-table-view-cell { padding-left:31px; background-position:31px 100% }  
			.mui-collapse-content{margin-left: 30px;}  
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" id="tempVue">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">{{titleName}}</h1>
			<a @click.stop="sure()" class="mui-pull-right" style="font-size: 14px;margin-top: 0px;">确定</a>
		</header>
		<div id="datasource" class="mui-content mui-fullscreen" style="z-index:0" v-cloak>
			<div class="mui-scroll-wrapper" style="margin-top: 44px;" v-cloak>
				<div class="mui-scroll" v-cloak>
					<div v-if="dataFlag == 1">
						<div class="mui-scroll" v-cloak>
							<ul class="mui-table-view" v-cloak>
								<li v-for="model in pageArray" class="mui-table-view-cell" @tap="clickGrdLi(model)">
									<div class="mui-table">
										<div class="mui-table-cell">
											<div v-if="model.grdFlag == 1&&model.stuArray.length==0" class="mui-input-row mui-checkbox mui-left mui-disabled">
												<label>{{model.name}} <span style="font-size: 12px;margin-left: 30px;">暂无学生</span></label>
												<input name="checkbox1" value="Item 1" type="checkbox" disabled="disabled">
											</div> 
											<div v-else-if="model.selectFlag == 0" class="mui-input-row mui-checkbox mui-left">
												<label>{{model.name}}</label>
												<input name="checkbox1" value="Item 1" type="checkbox">
											</div>
											<div v-else-if="model.selectFlag == 1" class="mui-input-row mui-checkbox mui-left">
												<label>{{model.name}}</label>
												<input name="checkbox1" value="Item 1" type="checkbox" checked>
											</div>
										</div>
									</div>
								</li>
							</ul>
						</div>
					</div>
					<div v-if="dataFlag == 2">
						<ul class="mui-table-view" v-cloak>
							<li class="mui-table-view-cell mui-collapse" v-for="model in pageArray" @tap="clickGrdLi(model)">
								<a class="mui-navigate-right" href="#">{{model.name}}</a>
								<div class="mui-collapse-content">
									<ul v-if="model.grdFlag == 1&&model.clsArray.length==0" class="mui-table-view" style="margin-top: -7px;margin-left: -30px;"
									 v-cloak>
										<li class="mui-table-view-cell">
											<div class="mui-table">
												<div class="mui-table-cell">
													<label style="margin-left: 20px;color: firebrick;">暂无班级</label>
												</div>
											</div>
										</li>
									</ul>
									<ul v-else="" class="mui-table-view" style="margin-top: -7px;margin-left: -30px;" v-cloak>
										<li v-for="clsmodel in model.clsArray" class="mui-table-view-cell" @tap="clickClsLi(clsmodel)">
											<div class="mui-table">
												<div class="mui-table-cell">
													<div v-if="clsmodel.clsFlag == 1&&clsmodel.stuArray.length==0" class="mui-input-row mui-checkbox mui-left mui-disabled">
														<label>{{clsmodel.name}}<span style="font-size: 12px;margin-left: 30px;">暂无学生</span></label>
														<input name="checkbox1" value="Item 1" type="checkbox" disabled="disabled">
													</div>
													<div v-else-if="clsmodel.selectFlag == 0" class="mui-input-row mui-checkbox mui-left">
														<label>{{clsmodel.name}}</label>
														<input name="checkbox1" value="Item 1" type="checkbox">
													</div>
													<div v-else-if="clsmodel.selectFlag == 1" class="mui-input-row mui-checkbox mui-left">
														<label>{{clsmodel.name}}</label>
														<input name="checkbox1" value="Item 1" type="checkbox" checked>
													</div>
												</div>
											</div>
										</li>
									</ul>
								</div>
							</li>
						</ul>
					</div>
					<div v-if="dataFlag == 3">
						<ul class="mui-table-view" v-cloak>
							<li class="mui-table-view-cell mui-collapse-3" v-for="model in pageArray" @tap="clickGrdLi(model)">
								<a class="mui-navigate-right" href="#">{{model.name}}</a>
								<div class="mui-collapse-content">
									<ul v-if="model.grdFlag == 1&&model.clsArray.length==0" class="mui-table-view" style="margin-left: -50px;"
									 v-cloak>
										<li class="mui-table-view-cell">
											<div class="mui-table">
												<div class="mui-table-cell">
													<label style="margin-left: 20px;color: firebrick;">暂无班级</label>
												</div>
											</div>
										</li>
									</ul>
									<ul v-else="" class="mui-table-view" style="margin-left: -55px;" v-cloak>
										<li class="mui-table-view-cell mui-collapse-3" v-for="clsModel in model.clsArray" @tap="clickClsLi(clsModel)">
											<a class="mui-navigate-right" href="#">{{clsModel.name}}</a>
											<div class="mui-collapse-content">
												<ul v-if="clsModel.clsFlag == 1&&clsModel.stuArray.length==0" class="mui-table-view" style="margin-left: -50px;"
												 v-cloak>
													<li class="mui-table-view-cell">
														<div class="mui-table">
															<div class="mui-table-cell">
																<label style="margin-left: 20px;color: firebrick;">暂无学生</label>
															</div>
														</div>
													</li>
												</ul>
												<ul v-else="" class="mui-table-view" style="margin-left: -50px;" v-cloak>
													<li v-for="stuModel in clsModel.stuArray" class="mui-table-view-cell" @tap="clickStuLi(stuModel)">
														<div class="mui-table">
															<div class="mui-table-cell">
																<div class="mui-input-row mui-checkbox mui-left">
																	<label>{{stuModel.name}}</label>
																	<div v-if="stuModel.selectFlag == 0">
																		<input name="checkbox1" value="Item 1" type="checkbox">
																	</div>
																	<div v-else-if="stuModel.selectFlag == 1">
																		<input name="checkbox1" value="Item 1" type="checkbox" checked>
																	</div>
																</div>
															</div>
														</div>
													</li>
												</ul>
											</div>
										</li>
									</ul>
								</div>
							</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		<script src="../../js/utils/mui.js"></script>
		<script src="../../js/utils/storageKeyName.js"></script>
		<script src="../../js/utils/vconsole.min.js"></script>
		<script src="../../js/utils/vue.js"></script>
		<script src="../../js/utils/publicProtocol.js"></script>
		<script src="../../js/utils/store.js"></script>
		<script src="../../js/utils/utils.js"></script>
		<script src="../../js/utils/events.js"></script>
		<!--加密-->
		<script src="../../js/libs/RSA/Barrett.js"></script>
		<script src="../../js/libs/RSA/BigInt.js"></script>
		<script src="../../js/libs/RSA/RSA.js"></script>
		<script src="../../js/libs/encryption/RSAEncrypt.js"></script>
		<script src='../../js/libs/crypto-js/require.js'></script>
		<script src='../../js/libs/encryption/signHmacSHA1.js'></script>
		<script src='../../js/libs/jquery.js'></script>
		<script src='../../js/libs/encryption/sortSign.js'></script>
		<script type="text/javascript">
			//获取个人信息
			var personal = store.get(window.storageKeyName.PERSONALINFO);
			console.log('personal:' + JSON.stringify(personal));
			var curPage = {};
			var pageIndex = 1; //请求数据页面
			var totalPageCount; //总页码
			var flagRef = 0; //是刷新0，还是加载更多1
			var tempVue = new Vue({
				el: "#tempVue",
				data: {
					titleName: ''
				},
				methods: {
					sure: function() {
						console.log('datasource.pageArray:' + JSON.stringify(datasource.pageArray));
						if (datasource.dataFlag == 1) {
							let selectData = []
							datasource.pageArray.map(function(item) {
								if (item.selectFlag == 1) {
									selectData.push(item)
								}
							})
							let obj = {}
							obj.grdCode = selectData
							mui.fire(plus.webview.currentWebview().opener(), 'refreshStudent', selectData);
							setTimeout(function() {
								mui.back()
							}, 100)
						} else if (datasource.dataFlag == 2) {
							let selectData = []
							datasource.pageArray.map(function(item) {
								var tempGrd = {
									name: item.name,
									value: item.value,
									children: []
								}
								item.clsArray.map(function(clsItem) {
									if (clsItem.selectFlag == 1) {
										tempGrd.children.push(clsItem);
									}
								})
								if (tempGrd.children.length > 0) {
									selectData.push(tempGrd);
								}
							})
							console.log('selectData:' + JSON.stringify(selectData));
							let obj = {}
							obj.grdCode = selectData
							mui.fire(plus.webview.currentWebview().opener(), 'refreshStudent', selectData);
							setTimeout(function() {
								mui.back()
							}, 100)
						} else if (datasource.dataFlag == 3) {
							let selectData = []
							datasource.pageArray.map(function(item) {
								var tempGrd = {
									name: item.name,
									value: item.value,
									children: []
								}
								item.clsArray.map(function(clsItem) {
									var tempCls = {
										name: clsItem.name,
										value: clsItem.value,
										grdValue: clsItem.grdValue,
										children: []
									}
									clsItem.stuArray.map(function(stuItem) {
										if (stuItem.selectFlag == 1) {
											tempCls.children.push(stuItem);
										}
									})
									if (tempCls.children.length > 0) {
										tempGrd.children.push(tempCls);
									}
								})
								if (tempGrd.children.length > 0) {
									selectData.push(tempGrd);
								}
							})
							console.log('selectData:' + JSON.stringify(selectData));
							let obj = {}
							obj.grdCode = selectData
							mui.fire(plus.webview.currentWebview().opener(), 'refreshStudent', selectData);
							setTimeout(function() {
								mui.back()
							}, 100)
						}
					}
				}
			});
			var datasource = new Vue({
				el: "#datasource",
				data: {
					dataFlag: 0, //1选择年级，2选择班级，3选择学生
					pageArray: [] //界面总数组
				},
				methods: {
					clickGrdLi: function(model) {
						console.log('clickGrdLi.model:' + JSON.stringify(model));
						if (datasource.dataFlag == 1) {
							if (model.grdFlag == 1 && model.stuArray.length > 0) {
								if (model.selectFlag == 0) {
									model.selectFlag = 1;
								} else {
									model.selectFlag = 0;
								}
							}
							if (model.grdFlag == 0) {
								//获取数据范围授权：学生
								getStuDataArray(model);
							}
						} else if (datasource.dataFlag == 2 || datasource.dataFlag == 3) {
							if (model.grdFlag == 0) {
								//获取数据范围授权：班级
								getClsDataArray(model);
							}
							if (datasource.dataFlag == 3) {
								mui(".mui-scroll-wrapper").scroll().refresh();
							}
						}
					},
					clickClsLi: function(model) {
						console.log('clickClsLi.model:' + JSON.stringify(model));
						if (datasource.dataFlag == 2) {
							if (model.clsFlag == 1 && model.stuArray.length > 0) {
								if (model.selectFlag == 0) {
									model.selectFlag = 1;
								} else {
									model.selectFlag = 0;
								}
							}
						}
						if (model.clsFlag == 0) {
							//获取数据范围授权：学生
							getStuDataArray(model);
						}
					},
					clickStuLi: function(model) {
						console.log('clickStuLi.model:' + JSON.stringify(model));
						if (model.selectFlag == 0) {
							model.selectFlag = 1;
						} else {
							model.selectFlag = 0;
						}
					}
				}
			});
			mui.init();

			mui.plusReady(function() {
				curPage = utils.getDataFromUrl(window.location.href);
				console.log('2222:' + JSON.stringify(curPage));
				tempVue.titleName = curPage.name;
				datasource.dataFlag = curPage.dataFlag;
				events.showWaiting();
				//获取数据范围授权：年级
				getGrdDataArray();
				//阻尼系数、初始化刷新加载更多
				var deceleration = mui.os.ios ? 0.003 : 0.0009;
				mui('.mui-scroll-wrapper').scroll({
					bounce: false,
					indicators: true, //是否显示滚动条
					deceleration: deceleration
				});
			});

			//获取数据范围授权：年级
			function getGrdDataArray() {
				var comData = {
					get_grd: true,
					all_grd: false,
					index_code: curPage.access,
				}
				//获取数据范围授权：年级
				postDataEncry(window.storageKeyName.INTERFACE_HR_SUB + 'acl/dataRange', {}, comData, 2, function(data) {
					events.closeWaiting()
					if (data.code == 0) {
						try{
							for (var i = 0; i < data.data.grd_list.length; i++) {
								var tempM = data.data.grd_list[i];
								tempM.clsArray = [];
								tempM.stuArray = [];
								tempM.grdFlag = 0; //当前年级没有获取过班级0，获取过班级1
								var tempFlag = 0;
								if (curPage.selectData.length > 0) {
									for (var a = 0; a < curPage.selectData.length; a++) {
										if (tempM.value == curPage.selectData[a].value) {
											tempFlag++;
											if (datasource.dataFlag == 2 || datasource.dataFlag == 3) {
												//获取数据范围授权：班级
												getClsDataArray(tempM);
											}
										}
									}
									if (tempFlag == 0) {
										tempM.selectFlag = 0;
									} else {
										tempM.selectFlag = 1;
									}
								} else {
									tempM.selectFlag = 0;
								}
							}
							datasource.pageArray = data.data.grd_list;
						}catch(e){
							events.closeWaiting()
						}
					} else {
						events.closeWaiting()
						mui.toast(data.msg);
					}
				});
			};

			//获取数据范围授权：班级
			function getClsDataArray(grdModel) {
				const params = {
					grd_code: grdModel.value,
					get_cls: true,
					all_cls: false,
					index_code: curPage.access,
				}
				//获取数据范围授权：班级
				postDataEncry(window.storageKeyName.INTERFACE_HR_SUB + 'acl/dataRange', {}, params, 2, function(data) {
					events.closeWaiting()
					if (data.code == 0) {
						try{
							for (var i = 0; i < data.data.cls_list.length; i++) {
								var tempM = data.data.cls_list[i];
								tempM.clsFlag = 0; //当前班级没有获取过学生0，获取过学生1
								tempM.stuArray = [];
								tempM.grdValue = grdModel.value;
								var tempFlag = 0;
								if (curPage.selectData.length > 0) {
									for (var a = 0; a < curPage.selectData.length; a++) {
										var tempGrd = curPage.selectData[a];
										for (var b = 0; b < tempGrd.children.length; b++) {
											var tempCls = tempGrd.children[b];
											if (tempM.value == tempCls.value) {
												tempFlag++;
												if (datasource.dataFlag == 3) {
													//获取数据范围授权：学生
													getStuDataArray(tempM);
												}
											}
										}
									}
									if (tempFlag == 0) {
										tempM.selectFlag = 0;
									} else {
										tempM.selectFlag = 1;
									}
								} else {
									tempM.selectFlag = 0;
								}
							}
							grdModel.grdFlag = 1;
							grdModel.clsArray = data.data.cls_list;
							console.log('datasource.pageArray:' + JSON.stringify(datasource.pageArray));
						}catch(e){
							events.closeWaiting();
						}
					} else {
						events.closeWaiting();
						mui.toast(data.msg);
					}
				});
			};

			//根据年级班级获取学生
			function getStuDataArray(clsModel) {
				var params = {}
				if (datasource.dataFlag == 1) {
					params = {
						grd_codes:clsModel.value,
						cls_codes:"",
						page_size:100000,
						page_number:-1,
						index_code: curPage.access,
					}
				} else if (datasource.dataFlag == 2) {
					params = {
						grd_codes: clsModel.grdValue,
						cls_codes: clsModel.value,
						page_size:100000,
						page_number:-1,
						index_code: curPage.access,
					}
				}
				postDataEncry(window.storageKeyName.INTERFACE_HR_SUB + 'stu', {}, params, 2, function(datas) {
					events.closeWaiting()
					if (datas.code == 0) {
						if (datasource.dataFlag == 1) {
							if (datas.data.list && datas.data.list.length > 0) {
								clsModel.stuArray = [1, 2];
								clsModel.selectFlag = 1;
							} else {
								clsModel.selectFlag = 0;
								mui.toast('当前年级没有学生');
							}
							clsModel.grdFlag = 1;
						} else if (datasource.dataFlag == 2) {
							if (datas.data.list && datas.data.list.length > 0) {
								clsModel.stuArray = [1, 2];
								clsModel.selectFlag = 1;
							} else {
								clsModel.selectFlag = 0;
								mui.toast('当前班级没有学生');
							}
							clsModel.clsFlag = 1;
						} else if (datasource.dataFlag == 3) {
							if(datas.data.list && datas.data.list.length > 0){
								for (var i = 0; i < datas.data.list.length; i++) {
									var tempM = datas.data.list[i];
									var tempFlag = 0;
									if (curPage.selectData.length > 0) {
										for (var a = 0; a < curPage.selectData.length; a++) {
											var tempGrd = curPage.selectData[a];
											for (var b = 0; b < tempGrd.children.length; b++) {
												var tempCls = tempGrd.children[b];
												for (var c = 0; c < tempCls.children.length; c++) {
													var tempStu = tempCls.children[c];
													if (tempM.value == tempStu.value) {
														tempFlag++;
													}
												}
											}
										}
										if (tempFlag == 0) {
											tempM.selectFlag = 0;
										} else {
											tempM.selectFlag = 1;
										}
									} else {
										tempM.selectFlag = 0;
									}
								}
								clsModel.clsFlag = 1;
								clsModel.stuArray = datas.data.list;
							} else {
								clsModel.selectFlag = 0;
								mui.toast('当前班级没有学生');
							}
						}
						// console.log('datasource.pageArray:' + JSON.stringify(datasource.pageArray));
					} else {
						mui.toast(data.msg);
					}
				});
			};
			
			
			//根据年级班级获取已订购的学生

			var inputTap = false;
			mui('.mui-scroll').on('tap', '.allSelect', function() {
				inputTap = true;
			});
			mui('.mui-scroll').on('tap', '.mui-navigate-right', function() {
				if (datasource.dataFlag == 3) {
					if (inputTap) {
						inputTap = false;
						return;
					}
					//记录状态  
					var li = this.parentNode;
					var ul = this.parentNode.querySelector('.mui-table-view');
					var _style = ul.style.display;
					//关闭同级菜单  
					// var parent = this.parentNode.parentNode.children;
					// for (var i = 0; i < parent.length; i++) {
					// 	if (!!parent[i].querySelector('.mui-table-view')) {
					// 		parent[i].querySelector('.mui-table-view').style.display = '';
					// 		removeClass(parent[i], 'mui-active');
					// 	}
					// }
					//更改状态  
					if (_style == 'block') {
						ul.style.display = '';
						removeClass(li, 'mui-active');
					} else {
						ul.style.display = 'block';
						addClass(li, 'mui-active');
					}
					//关闭下级子菜单  
					var children = ul.children;
					for (var i = 0; i < children.length; i++) {
						var child = children[i].querySelector('.mui-table-view');
						if (!!child) {
							child.style.display = '';
							removeClass(children[i], 'mui-active');
						}
					}
				}
			});

			function hasClass(obj, cls) {
				return obj.className.match(new RegExp('(\\s|^)' + cls + '(\\s|$)'));
			}

			function addClass(obj, cls) {
				if (!this.hasClass(obj, cls)) obj.className += " " + cls;
			}

			function removeClass(obj, cls) {
				if (hasClass(obj, cls)) {
					var reg = new RegExp('(\\s|^)' + cls + '(\\s|$)');
					obj.className = obj.className.replace(reg, '');
				}
			}
		</script>
	</body>

</html>
